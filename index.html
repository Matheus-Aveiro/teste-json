<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visualizador de Eventos ICS</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .container {
        margin-top: 50px;
      }
      .loading-text {
        color: #6c757d;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4 text-center">Eventos do Calendário</h1>
      <p class="text-center">
        Abaixo, a lista de eventos extraída diretamente do arquivo
        <a
          href="https://matheus-aveiro.github.io/teste-json/teste.ics"
          target="_blank"
          >teste.ics</a
        >
        no seu repositório.
      </p>

      <div class="text-center my-4">
        <a
          id="download-btn"
          href="https://matheus-aveiro.github.io/teste-json/teste.ics"
          download="meus-eventos.ics"
          class="btn btn-success btn-lg"
        >
          Baixar Calendário (.ics)
        </a>
      </div>

      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th scope="col">Título</th>
                  <th scope="col">Local</th>
                  <th scope="col">Data/Hora</th>
                </tr>
              </thead>
              <tbody id="events-table-body">
                <tr>
                  <td colspan="3" class="text-center loading-text">
                    Carregando eventos...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // SUBSTITUA esta URL pela URL RAW do seu arquivo teste.ics no GitHub
        const icsUrl = "https://matheus-aveiro.github.io/teste-json/teste.ics";
        const tableBody = document.getElementById("events-table-body");
        const downloadBtn = document.getElementById("download-btn");

        fetch(icsUrl)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Erro ao carregar o arquivo .ics");
            }
            return response.text();
          })
          .then((text) => {
            const jcalData = ICAL.parse(text);
            const comp = new ICAL.Component(jcalData);
            const events = comp.getAllSubcomponents("vevent");

            if (events.length === 0) {
              tableBody.innerHTML =
                '<tr><td colspan="3" class="text-center">Nenhum evento encontrado.</td></tr>';
              return;
            }

            tableBody.innerHTML = ""; // Limpa a mensagem de carregamento
            events.forEach((event) => {
              const summary = event.getFirstPropertyValue("summary");
              const location = event.getFirstPropertyValue("location");
              const start = event.getFirstPropertyValue("dtstart").toJSDate();

              // Formatação da data para o formato brasileiro
              const options = {
                year: "numeric",
                month: "long",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
              };
              const formattedDate = start.toLocaleString("pt-BR", options);

              const row = document.createElement("tr");
              row.innerHTML = `
                            <td>${summary || "N/A"}</td>
                            <td>${location || "N/A"}</td>
                            <td>${formattedDate || "N/A"}</td>
                        `;
              tableBody.appendChild(row);
            });

            // Atualiza o link do botão de download com a URL correta
            downloadBtn.href = icsUrl;
          })
          .catch((error) => {
            console.error("Ocorreu um erro:", error);
            tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Falha ao carregar eventos. Verifique a URL do arquivo.</td></tr>`;
            downloadBtn.style.display = "none"; // Esconde o botão se houver erro
          });
      });
    </script>
  </body>
</html>
